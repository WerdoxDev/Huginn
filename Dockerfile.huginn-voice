# use the official Bun image
# see all versions at https://hub.docker.com/r/oven/bun/tags
FROM debian AS base
LABEL org.opencontainers.image.source=https://github.com/werdoxdev/huginn
WORKDIR /src

RUN apt update && apt install -y curl python3 python3-pip unzip && rm -rf /var/lib/apt/lists/*
RUN curl -fsSL https://deb.nodesource.com/setup_23.x | bash - && apt install -y nodejs
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/usr/local/bin:$PATH"
ENV PATH="/root/.bun/bin:$PATH"
RUN bun -v && node -v && npm -v && python3 --version && pip3 --version

# install dependencies into temp directory
# this will cache them and speed up future builds
FROM base AS install
RUN mkdir -p /temp/deps
COPY package.json bun.lock .npmrc /temp/deps/
COPY packages/huginn-backend-shared/package.json /temp/deps/packages/huginn-backend-shared/package.json
COPY packages/huginn-shared/package.json /temp/deps/packages/huginn-shared/package.json
COPY packages/huginn-voice/package.json /temp/deps/packages/huginn-voice/package.json
RUN cd /temp/deps && bun install
# RUN ls -lah /temp/deps && tree /temp/deps

# copy node_modules from temp directory
# then copy all (non-ignored) project files into the image
FROM base AS prerelease
COPY --from=install /temp/deps/node_modules node_modules
COPY . /src
RUN rm -rf /src/packages/huginn-server
RUN rm -rf /src/packages/huginn-cdn
RUN cd packages/huginn-backend-shared && bunx prisma generate
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# run the app
# RUN mkdir -p packages/huginn-cdn/uploads
# RUN chown -R bun:bun packages/huginn-cdn/uploads
# RUN chown -R bun:bun packages/huginn-server/package.json
# RUN chmod 755 packages/huginn-cdn/uploads
# RUN chmod 755 packages/huginn-server/package.json
# USER bun
EXPOSE 3003/tcp
EXPOSE 44444/tcp
ENTRYPOINT ["/entrypoint.sh"]
CMD ["packages/huginn-voice", "voice", "npm"]
